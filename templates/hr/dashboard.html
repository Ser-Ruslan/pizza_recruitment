{% extends 'base.html' %}

{% block title %}Панель HR - PizzaJobs{% endblock %}

{% block extra_css %}
<style>
    .stat-card {
        transition: transform 0.3s;
    }
    .stat-card:hover {
        transform: translateY(-5px);
    }
    .trend-card {
        border-left: 4px solid;
        transition: all 0.3s ease;
    }
    .trend-card:hover {
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    .trend-positive { border-left-color: #28a745; }
    .trend-negative { border-left-color: #dc3545; }
    .trend-neutral { border-left-color: #6c757d; }
    .trend-icon {
        font-size: 1.2em;
        margin-right: 0.5rem;
    }
    .metric-value {
        font-size: 1.8rem;
        font-weight: bold;
        margin-bottom: 0.25rem;
    }
    .metric-label {
        color: #6c757d;
        font-size: 0.9rem;
        margin-bottom: 0.5rem;
    }
    .trend-value {
        font-size: 0.85rem;
        font-weight: 600;
    }
    .period-selector {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 0.5rem;
        margin-bottom: 1.5rem;
    }
    .period-btn {
        border: none;
        background: transparent;
        padding: 0.5rem 1rem;
        border-radius: 6px;
        transition: all 0.3s;
        color: #6c757d;
        font-size: 0.85rem;
    }
    .period-btn.active {
        background: #007bff;
        color: white;
        box-shadow: 0 2px 4px rgba(0,123,255,0.3);
    }
    .period-btn:hover:not(.active) {
        background: #e9ecef;
        color: #495057;
    }
    .trends-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="fas fa-chart-line me-2 text-danger"></i>Панель HR</h1>
        <div>
            <a href="{% url 'create_vacancy' %}" class="btn btn-danger me-2">
                <i class="fas fa-plus-circle me-2"></i>Создать вакансию
            </a>
            <a href="{% url 'quick_applications' %}" class="btn btn-warning me-2">
                <i class="fas fa-bolt me-2"></i>Быстрые заявки
            </a>
            <a href="{% url 'manage_candidates' %}" class="btn btn-success">
                <i class="fas fa-users me-2"></i>Кандидаты
            </a>
        </div>
    </div>

    <!-- Селектор периода для трендов -->
    <div class="card shadow mb-4">
        <div class="card-header bg-white">
            <h3 class="card-title h5 mb-0">
                <i class="fas fa-chart-line me-2 text-primary"></i>Статистика и тренды
            </h3>
        </div>
        <div class="card-body">
            <!-- Селектор периода -->
            <div class="period-selector text-center">
                <small class="text-muted d-block mb-2">Сравнить с периодом:</small>
                <button class="period-btn active" data-period="1_week">1 неделя</button>
                <button class="period-btn" data-period="2_weeks">2 недели</button>
                <button class="period-btn" data-period="1_month">1 месяц</button>
                <button class="period-btn" data-period="2_months">2 месяца</button>
                <button class="period-btn" data-period="6_months">6 месяцев</button>
                <button class="period-btn" data-period="1_year">1 год</button>
            </div>

            <!-- Основные метрики с трендами -->
            <div class="trends-grid">
                <!-- Вакансии -->
                <div class="card trend-card trend-positive border-0" id="trend-vacancies">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <div class="metric-value text-primary">{{ total_vacancies }}</div>
                                <div class="metric-label">Всего вакансий</div>
                                <div class="trend-value">
                                    <span class="trend-icon text-success">↗</span>
                                    <span class="trend-text text-success">+0% за неделю</span>
                                </div>
                            </div>
                            <i class="fas fa-briefcase fa-2x text-primary opacity-25"></i>
                        </div>
                        <div class="mt-2">
                            <small class="text-muted">Активных: {{ active_vacancies }}</small>
                        </div>
                    </div>
                </div>

                <!-- Отклики -->
                <div class="card trend-card trend-positive border-0" id="trend-applications">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <div class="metric-value text-info">{{ total_all_applications }}</div>
                                <div class="metric-label">Всего откликов</div>
                                <div class="trend-value">
                                    <span class="trend-icon text-success">↗</span>
                                    <span class="trend-text text-success">+0% за неделю</span>
                                </div>
                            </div>
                            <i class="fas fa-paper-plane fa-2x text-info opacity-25"></i>
                        </div>
                        <div class="mt-2">
                            <small class="text-muted">Быстрых: {{ total_quick_applications }}</small>
                        </div>
                    </div>
                </div>

                <!-- Новые заявки -->
                <div class="card trend-card trend-positive border-0" id="trend-new-applications">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <div class="metric-value text-warning">{{ new_regular_applications }} + {{ new_quick_applications }}</div>
                                <div class="metric-label">Новые заявки</div>
                                <div class="trend-value">
                                    <span class="trend-icon text-success">↗</span>
                                    <span class="trend-text text-success">+0% за неделю</span>
                                </div>
                            </div>
                            <i class="fas fa-bell fa-2x text-warning opacity-25"></i>
                        </div>
                        <div class="mt-2">
                            <small class="text-muted">Обычных / Быстрых</small>
                        </div>
                    </div>
                </div>

                <!-- Принятые заявки -->
                <div class="card trend-card trend-positive border-0" id="trend-accepted">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <div class="metric-value text-success" id="accepted-count">
                                    {{ processed_applications }}
                                </div>
                                <div class="metric-label">Обработано заявок</div>
                                <div class="trend-value">
                                    <span class="trend-icon text-success">↗</span>
                                    <span class="trend-text text-success">+0% за неделю</span>
                                </div>
                            </div>
                            <i class="fas fa-check-circle fa-2x text-success opacity-25"></i>
                        </div>
                    </div>
                </div>

                <!-- Интервью -->
                <div class="card trend-card trend-positive border-0" id="trend-interviews">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <div class="metric-value text-purple">{{ interviews_scheduled }}</div>
                                <div class="metric-label">Запланировано интервью</div>
                                <div class="trend-value">
                                    <span class="trend-icon text-success">↗</span>
                                    <span class="trend-text text-success">+0% за неделю</span>
                                </div>
                            </div>
                            <i class="fas fa-handshake fa-2x text-purple opacity-25" style="color: #6f42c1!important;"></i>
                        </div>
                        <div class="mt-2">
                            <small class="text-muted">Всего интервью: {{ trend_data.current.interviews_total }}</small>
                        </div>
                    </div>
                </div>

                <!-- Успешность тестов -->
                <div class="card trend-card trend-positive border-0" id="trend-tests">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <div class="metric-value text-dark">{{ test_statistics.success_rate|floatformat:1 }}%</div>
                                <div class="metric-label">Успешность тестов</div>
                                <div class="trend-value">
                                    <span class="trend-icon text-success">↗</span>
                                    <span class="trend-text text-success">+0% за неделю</span>
                                </div>
                            </div>
                            <i class="fas fa-clipboard-check fa-2x text-dark opacity-25"></i>
                        </div>
                        <div class="mt-2">
                            <small class="text-muted">Пройдено: {{ test_statistics.passed_attempts }}/{{ test_statistics.total_attempts }}</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Недавние отклики -->
        <div class="col-lg-7 mb-4">
            <div class="card shadow">
                <div class="card-header bg-white">
                    <h3 class="card-title h5 mb-0">Недавние отклики</h3>
                </div>
                <div class="card-body">
                    {% if recent_applications %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Имя</th>
                                        <th>Должность</th>
                                        <th>Дата отклика</th>
                                        <th>Статус</th>
                                        <th>Действия</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for application in recent_applications %}
                                        <tr>
                                            <td>{{ application.user.get_full_name }}</td>
                                            <td>{{ application.vacancy.title }}</td>
                                            <td>{{ application.applied_at|date:"d M, Y" }}</td>
                                            <td>
                                                <span class="badge {% if application.status == 'NEW' %}bg-primary{% elif application.status == 'REVIEWING' %}bg-info{% elif application.status == 'INTERVIEW_SCHEDULED' %}bg-warning{% elif application.status == 'ACCEPTED' %}bg-success{% elif application.status == 'REJECTED' %}bg-danger{% else %}bg-secondary{% endif %}">
                                                    {{ application.get_status_display }}
                                                </span>
                                            </td>
                                            <td>
                                                <a href="{% url 'application_detail' application.id %}" class="btn btn-sm btn-outline-secondary">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        <div class="text-center mt-3">
                            <a href="{% url 'application_list' %}" class="btn btn-sm btn-outline-secondary">
                                Просмотреть все отклики
                            </a>
                        </div>
                    {% else %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>Нет недавних откликов для отображения.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Графики и статистика -->
        <div class="col-lg-5 mb-4">
            <div class="card shadow mb-4">
                <div class="card-header bg-white">
                    <h3 class="card-title h5 mb-0">Отклики по статусу</h3>
                </div>
                <div class="card-body">
                    {% if applications_by_status %}
                        <div class="chart-container" style="position: relative; height:250px; width:100%">
                            <canvas id="applicationStatusChart"></canvas>
                        </div>
                    {% else %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>Нет данных для отображения.
                        </div>
                    {% endif %}
                </div>
            </div>

            <div class="card shadow">
                <div class="card-header bg-white">
                    <h3 class="card-title h5 mb-0">Вакансии по статусу</h3>
                </div>
                <div class="card-body">
                    {% if vacancies_by_status %}
                        <div class="chart-container" style="position: relative; height:250px; width:100%">
                            <canvas id="vacancyStatusChart"></canvas>
                        </div>
                    {% else %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>Нет данных для отображения.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Статистика тестирования -->
    <div class="card shadow mb-4">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
            <h3 class="card-title h5 mb-0">Статистика тестирования по компетенциям</h3>
            <a href="{% url 'test_statistics' %}" class="btn btn-sm btn-outline-primary">
                <i class="fas fa-history me-2"></i>Подробная статистика
            </a>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-lg-8">
                    {% if test_statistics.competency_stats %}
                        <div class="table-responsive">
                            <table class="table table-hover table-sm">
                                <thead class="table-light">
                                    <tr>
                                        <th>Компетенция</th>
                                        <th>Попыток</th>
                                        <th>Успешных</th>
                                        <th>Успешность</th>
                                        <th>Средний балл</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for stat in test_statistics.competency_stats %}
                                    <tr>
                                        <td><span class="badge bg-primary">{{ stat.position_type }}</span></td>
                                        <td>{{ stat.total_attempts }}</td>
                                        <td>{{ stat.passed_attempts }}</td>
                                        <td>
                                            <div class="progress" style="height: 20px;">
                                                <div class="progress-bar {% if stat.success_rate >= 80 %}bg-success{% elif stat.success_rate >= 60 %}bg-warning{% else %}bg-danger{% endif %}" 
                                                     role="progressbar" style="width: {{ stat.success_rate }}%;">
                                                    {{ stat.success_rate|floatformat:1 }}%
                                                </div>
                                            </div>
                                        </td>
                                        <td>{{ stat.avg_score|floatformat:1 }}%</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>Нет данных о тестировании для отображения.
                        </div>
                    {% endif %}
                </div>

                <div class="col-lg-4">
                    {% if test_statistics.competency_stats %}
                        <div class="chart-container" style="position: relative; height:300px; width:100%">
                            <canvas id="competencyChart"></canvas>
                        </div>
                    {% else %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>Нет данных для диаграммы.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Chart.js для визуализации данных -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Данные трендов из Django
    const trendData = {{ trend_data|safe }};
    const trends = {{ trends|safe }};

    // Функция обновления трендов
    function updateTrends(selectedPeriod) {
        console.log('=== ДАННЫЕ ТРЕНДОВ ===');
        console.log('trendData:', trendData);
        console.log('trends:', trends);
        console.log('selectedPeriod:', selectedPeriod);
        
        const currentData = trendData.current;
        const periodTrends = trends[selectedPeriod];
        
        console.log('currentData:', currentData);
        console.log('periodTrends:', periodTrends);
        console.log('======================');

        // Обновление карточек
        updateTrendCard('trend-vacancies', currentData.vacancies_total, periodTrends.vacancies_total, 'вакансий');
        updateTrendCard('trend-applications', currentData.applications_total, periodTrends.applications_total, 'откликов');
        updateTrendCard('trend-new-applications', currentData.applications_new + currentData.quick_apps_new, periodTrends.applications_new, 'новых заявок');
        updateTrendCard('trend-accepted', currentData.applications_accepted, periodTrends.applications_accepted, 'принятых');
        updateTrendCard('trend-interviews', currentData.interviews_scheduled, periodTrends.interviews_total, 'интервью');
        updateTrendCard('trend-tests', currentData.test_success_rate, periodTrends.test_success_rate, 'успешности');
    }

    function updateTrendCard(cardId, currentValue, trendValue, suffix) {
        const card = document.getElementById(cardId);
        if (!card) return;

        const trendIcon = card.querySelector('.trend-icon');
        const trendText = card.querySelector('.trend-text');

        // Определяем направление тренда
        let icon, colorClass, text;
        if (trendValue > 0) {
            icon = '↗';
            colorClass = 'text-success';
            text = `+${trendValue}%`;
        } else if (trendValue < 0) {
            icon = '↘';
            colorClass = 'text-danger';
            text = `${trendValue}%`;
        } else {
            icon = '→';
            colorClass = 'text-muted';
            text = '0%';
        }

        // Обновляем иконку и текст
        trendIcon.textContent = icon;
        trendIcon.className = `trend-icon ${colorClass}`;
        trendText.textContent = `${text} за выбранный период`;
        trendText.className = `trend-text ${colorClass}`;

        // Обновляем класс карточки
        card.className = card.className.replace(/trend-(positive|negative|neutral)/, '');
        if (trendValue > 0) {
            card.classList.add('trend-positive');
        } else if (trendValue < 0) {
            card.classList.add('trend-negative');
        } else {
            card.classList.add('trend-neutral');
        }
    }

    // Обработчики кнопок периода
    document.querySelectorAll('.period-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            // Убираем active у всех кнопок
            document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
            // Добавляем active к текущей
            this.classList.add('active');

            // Обновляем тренды
            const period = this.dataset.period;
            updateTrends(period);
        });
    });

    // Инициализация с периодом 1 неделя
    updateTrends('1_week');

    // Конфигурация статусов откликов
    const statusConfig = {
        'NEW': { label: 'Новые', badge: 'bg-primary', color: 'rgba(13, 110, 253, 0.7)' },
        'REVIEWING': { label: 'На рассмотрении', badge: 'bg-info', color: 'rgba(13, 202, 240, 0.7)' },
        'INTERVIEW_SCHEDULED': { label: 'Собеседование назначено', badge: 'bg-warning text-dark', color: 'rgba(255, 193, 7, 0.7)' },
        'ACCEPTED': { label: 'Приняты', badge: 'bg-success', color: 'rgba(25, 135, 84, 0.7)' },
        'REJECTED': { label: 'Отклонены', badge: 'bg-danger', color: 'rgba(220, 53, 69, 0.7)' }
    };

    // --- Диаграмма: Отклики по статусу ---
    {% if applications_by_status %}
    const statusLabels = [], statusData = [], statusColors = [];

    {% for item in applications_by_status %}
        (function() {
            const code = "{{ item.status }}";
            const count = {{ item.count }};
            const cfg = statusConfig[code] || { label: code, badge: 'bg-secondary', color: 'rgba(108, 117, 125, 0.7)' };
            statusLabels.push(cfg.label);
            statusData.push(count);
            statusColors.push(cfg.color);
        })();
    {% endfor %}

    const ctx = document.getElementById('applicationStatusChart').getContext('2d');
    new Chart(ctx, {
        type: 'pie',
        data: {
            labels: statusLabels,
            datasets: [{
                data: statusData,
                backgroundColor: statusColors,
                borderColor: statusColors.map(c => c.replace('0.7','1')),
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'right', labels: { boxWidth: 15 } }
            }
        }
    });
    {% endif %}

    // --- Диаграмма: Вакансии по статусу ---
    {% if vacancies_by_status %}
    const vacancyCtx = document.getElementById('vacancyStatusChart').getContext('2d');
    const vacancyData = {
        labels: ['Активные','Неактивные'],
        datasets: [{
            data: [
                {% for item in vacancies_by_status %}
                    {% if item.is_active %}{{ item.count }}{% endif %}
                {% endfor %},
                {% for item in vacancies_by_status %}
                    {% if not item.is_active %}{{ item.count }}{% endif %}
                {% endfor %}
            ],
            backgroundColor: ['rgba(25, 135, 84, 0.7)', 'rgba(220, 53, 69, 0.7)'],
            borderColor: ['rgba(25, 135, 84, 1)', 'rgba(220, 53, 69, 1)'],
            borderWidth: 1
        }]
    };
    new Chart(vacancyCtx, {
        type: 'doughnut',
        data: vacancyData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'right', labels: { boxWidth: 15 } }
            }
        }
    });
    {% endif %}

    // --- Диаграмма: Успешность по компетенциям ---
    {% if test_statistics.competency_stats %}
    const competencyLabels = [];
    const competencyData = [];
    const colorPalette = [
        'rgba(255, 99, 132, 0.7)',
        'rgba(54, 162, 235, 0.7)', 
        'rgba(255, 205, 86, 0.7)',
        'rgba(75, 192, 192, 0.7)',
        'rgba(153, 102, 255, 0.7)',
        'rgba(255, 159, 64, 0.7)'
    ];

    {% for stat in test_statistics.competency_stats %}
    competencyLabels.push('{{ stat.position_type|escapejs }}');
    competencyData.push(parseFloat('{{ stat.success_rate|floatformat:1 }}'));
    {% endfor %}

    const competencyColors = competencyLabels.map((_, index) => colorPalette[index % colorPalette.length]);

    const competencyCtx = document.getElementById('competencyChart');
    if (competencyCtx) {
        new Chart(competencyCtx, {
            type: 'bar',
            data: {
                labels: competencyLabels,
                datasets: [{
                    label: 'Успешность (%)',
                    data: competencyData,
                    backgroundColor: competencyColors,
                    borderColor: competencyColors.map(color => color.replace('0.7', '1')),
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ' + context.parsed.y.toFixed(1) + '%';
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        ticks: {
                            maxRotation: 45,
                            minRotation: 0
                        }
                    },
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            },
                            stepSize: 20
                        }
                    }
                }
            }
        });
    }
    {% endif %}
});
</script>
{% endblock %}